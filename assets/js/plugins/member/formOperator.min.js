(function($) {
    let pssForm = ['passwd1','passwd2','passwd3'],
        nkprop = $('input[name=nickname]'),
        nlabel = nkprop.prevAll('small').eq(0),
        oprbtn = $('#data-operator'); 
    pssForm.forEach((item) => {
        $('input[name='+item+']').customInputPasswd();
    })
    // buat atribut kosong blur untuk menyimpan aksi blur
    if (typeof oprbtn.attr('data-blur') === "undefined") {
        oprbtn.attr('data-blur','');
    }
    nlabel.attr('data-text',nlabel.text());
    // cek ketersediaan nama login baru
    nkprop.on('blur',function(){
        let __this = $(this);            
        nlabel.removeClass('text-danger text-warning text-success').text(nlabel.data('text'));        
        if(oprbtn.attr('disabled') && oprbtn.data('blur') === 'event_nick'){
            oprbtn.attr('disabled',false).data('blur','');
        }
        if(!oprbtn.attr('disabled')){
            if(!__this.val()){
                nlabel.addClass('text-danger').text(nlabel.data('text')+' tidak boleh kosong!');
                __this.val(__this.data('nick'));
            }else{
                if(__this.val() !== __this.data('nick')){
                    // check minimal nama login baru 5 karakter
                    if(__this.val().length < 5){
                        nlabel.addClass('text-danger').text(nlabel.data('text')+' min 5 karakter!');
                        oprbtn.attr('disabled',true).data('blur','event_nick');
                        return;
                    }
                    // cek ketersediaan nama login baru di serverside
                    $.post('operator',{
                        mode : 'chk_nick',
                        token: $.sessionHandler().get('token'),
                        nickbaru: __this.val()
                    },function(response){
                        if(response.result){
                            nlabel.addClass('text-'+response.type).text(response.message);
                            if(response.type === 'warning' || response.type === 'danger')                           
                                oprbtn.attr('disabled',true).data('blur','event_nick');                      
                        }
                    })
                }
            }
        }else{
            __this.val(__this.data('nick'));
        }
    });
    // cek konfirmasi password
    let inpPass0 = $('input[name='+pssForm[0]+']'),
        inpPass1 = $('input[name='+pssForm[1]+']'),
        inpPass2 = $('input[name='+pssForm[2]+']'),
        lblPass0 = inpPass0.prevAll('small').eq(0),
        lblPass1 = inpPass1.prevAll('small').eq(0),
        lblPass2 = inpPass2.prevAll('small').eq(0);
    lblPass0.attr('data-text',lblPass0.text());
    lblPass1.attr('data-text',lblPass1.text());
    lblPass2.attr('data-text',lblPass2.text());
    inpPass0.on('blur',function(){
        let __this = $(this),
            tlabel = __this.prevAll('small').eq(0);
        // kembalikan label text password lama
        tlabel.removeClass('text-danger text-warning').text(tlabel.data('text'));
    });
    $('input[name='+pssForm[1]+'],input[name='+pssForm[2]+']').on('blur',function(){
        let __this = $(this),
            tlabel = __this.prevAll('small').eq(0); 
        tlabel.removeClass('text-danger').text(tlabel.data('text'));
        // jika password kurang dari 6 karakter
        if(__this.val() && __this.val().length < 6)                       
            tlabel.addClass('text-danger').text('Password baru min 6 karakter!')
    });
    $.fn.formOperator = function() {
        let __this = this;
        $(__this).on('click',function(){
            $(__this).ajaxButton('load');
            let secure = {},
                clogin = nkprop.data('nick'),
                nlogin = nkprop.val(),
                pgform = {
                    mode : 'update',
                    user_id : nkprop.data('id'),
                    nickname: clogin,
                    // nanti jika new login maka akan check di serversidenya
                    nickbaru: clogin === nlogin ? '' : nlogin,                    
                    realname: $('input[name=realname]').val(),
                    usr_phone: $('input[name=usr_phone]').val(),
                    usr_email: $('input[name=usr_email]').val(),
                    token: $.sessionHandler().get('token')
                };
            // add function
            function prosessOperator(){
                let formulir = $.extend(pgform,secure);
                // console.log(formulir);
                $.post('operator',formulir,function(response){
                    // kosongkan input password jika berhasil
                    $('input[name='+pssForm.join('],input[name=')+']').attr('data-text','').val('');
                    
                    if(response.result){
                        if(response.result.nick)
                            $('input[name=nickname]').attr('data-nick',response.result.nick);

                        if(response.result.aksi && response.result.aksi === 'restart'){
                            $.sessionHandler().remove('token');
                            App.getLogin();
                            $('.modal-backdrop').find('.close-btn').on('click', function() {
                                window.location.href = App.parseHttp().base ;
                            });

                        }
                        
                    }
                }).always(()=>{
                    $(__this).ajaxButton('stop');
                })
            }
            pssForm.forEach((item)=>{
                secure[item] = $('input[name='+item+']').data('text');
            });            
            if(secure.passwd2 && secure.passwd3){
                if(inpPass1.val().length < 6 || inpPass2.val().length < 6){
                    $(__this).ajaxButton('stop');
                    return;
                }   
                // cek jika password baru & konfirmasi tidak sama
                if(secure.passwd2 != secure.passwd3){
                    lblPass1.addClass('text-danger').text('Password baru harus sama!');
                    lblPass2.addClass('text-danger').text('Konfirmasi baru harus sama!');
                    $(__this).ajaxButton('stop');
                    return;
                }

                // check password lama
                if(secure.passwd1){
                    // kembalikan label text password lama
                    lblPass0.removeClass('text-danger').text(lblPass0.data('text'));
                    $.post('operator', { 
                        mode: 'chk_pass',
                        // ini bukan val password lama krana bisa berubah                    
                        nick: nkprop.data('nick'),
                        // data text karna memakai plugin custom input password
                        pass: inpPass0.data('text'),
                        token: $.sessionHandler().get('token')
                    }).done((response)=>{
                        if(response.type === 'warning' || response.type === 'danger'){
                            lblPass0.addClass('text-'+response.type).text(response.message);
                            $(__this).ajaxButton('stop');
                        }else{
                            // jika password lama benar
                            prosessOperator();
                        }                        
                    }); 
                }else{
                    // jika form ganti password terisi henti disini
                    lblPass0.addClass('text-warning').text("Password lama belum diisi!");
                    $(__this).ajaxButton('stop');
                }
                return 
            }
            prosessOperator();
            
        });
    };
})(jQuery);